<?php
require_once __DIR__ . '/../auth.php';
$me = user();
/* allow pages (e.g., login.php) to set $auth_page = true */
if (!isset($auth_page)) { $auth_page = false; }
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Workshop17 - Ticketing System</title>
<style>
:root{
  --primary:#88C28F; /* W17 green */
  --primary-dark:#5a8860;
  --secondary:#8bc34a;
  --accent:#4caf50;
  --danger:#ef4444;
  --warning:#ff9800;
  --dark:#2c3e50;
  --gray:#6b7280;
  --light:#f5f7fa;
  --white:#fff;
  --shadow:0 2px 4px rgba(0,0,0,.1);
  --shadow-lg:0 10px 25px rgba(0,0,0,.15);
  --radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f7fa;color:#111}
.wrap{display:flex;min-height:100vh}
.sidebar{
  width:260px;min-height:100vh;position:sticky;top:0;
  background:linear-gradient(180deg,var(--primary) 0%, var(--primary-dark) 100%);
  color:#fff;box-shadow:2px 0 10px rgba(0,0,0,.08)
}
.sidebar .brand{padding:1.25rem 1.5rem;background:rgba(0,0,0,.08);border-bottom:1px solid rgba(255,255,255,.12)}
.sidebar .brand h1{font-size:1.25rem;font-weight:700}
.sidebar .brand p{opacity:.9;margin-top:.25rem;font-size:.9rem}
.nav{padding:.5rem 0}
.nav a, .nav button{
  width:100%;display:flex;gap:.75rem;align-items:center;
  padding:1rem 1.5rem;color:#fff;text-decoration:none;background:transparent;border:0;cursor:pointer;font-size:.95rem
}
.nav a:hover, .nav button:hover{background:rgba(255,255,255,.12);padding-left:2rem;transition:.2s}
.nav .active{background:rgba(255,255,255,.2);border-left:4px solid #fff}
.main{flex:1;padding:2rem}
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem;overflow:hidden}
.card .card-h{padding:1rem 1.25rem;border-bottom:1px solid #eaecef;background:#fafafa;display:flex;justify-content:space-between;align-items:center}
.card .card-b{padding:1.25rem}
.btn{border:0;border-radius:10px;padding:.7rem 1.1rem;font-weight:700;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{filter:brightness(.95)}
.btn-danger{background:var(--danger);color:#fff}
.btn-secondary{background:var(--gray);color:#fff}
.table{width:100%;border-collapse:collapse}
.table th{background:#f8f9fa;text-align:left;padding:12px;border-bottom:2px solid #e5e7eb;font-size:.85rem;letter-spacing:.3px;text-transform:uppercase}
.table td{padding:12px;border-bottom:1px solid #eee}
.badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.72rem;font-weight:800}
.badge-success{background:rgba(76,175,80,.15);color:#2e7d32}
.badge-warning{background:rgba(255,152,0,.15);color:#b26a00}
.badge-danger{background:rgba(239,68,68,.15);color:#b91c1c}
.badge-primary{background:rgba(136,194,143,.18);color:#285d33}
.input, select, textarea{width:100%;padding:.75rem;border:1px solid #e1e4e8;border-radius:10px;background:#fafafa}
.input:focus, select:focus, textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(136,194,143,.2);background:#fff}
.grid{display:grid;gap:1rem}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:900px){.sidebar{display:none}.main{padding:1rem}}

/* ===== Auth (login) page styles ===== */
.auth-page{background:#88C28F;}
.auth-page .wrap{display:block;}
.auth-page .main{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
.auth-card{max-width:520px;width:100%;background:#fff;border-radius:24px;box-shadow:0 20px 50px rgba(0,0,0,.15);overflow:hidden}
.auth-card .card-h{background:#ffffff;border-bottom:1px solid #f0f2f4}
.auth-title{font-size:1.9rem;font-weight:800;color:#2c3e50;text-align:center}
.auth-body{padding:1.25rem 1.5rem 1.75rem}
.auth-group{margin:1rem 0}
.auth-input{width:100%;padding:0.95rem 1rem;border:1px solid #e1e4e8;border-radius:14px;background:#fbfbfb;font-size:1rem;transition:.2s;box-shadow:0 1px 0 rgba(0,0,0,.02) inset}
.auth-input:focus{outline:none;border-color:#88C28F;background:#fff;box-shadow:0 0 0 4px rgba(136,194,143,.18)}
.auth-btn{width:100%;border:0;border-radius:14px;padding:.95rem 1.2rem;font-weight:800;font-size:1rem;cursor:pointer;background:#88C28F;color:#fff;box-shadow:0 8px 20px rgba(136,194,143,.35);transition:.2s}
.auth-btn:hover{filter:brightness(.96)}
.auth-muted{margin-top:.9rem;text-align:center;font-size:.95rem;color:#6b7280}
.auth-muted a{color:#88C28F;text-decoration:none}
.auth-muted a:hover{text-decoration:underline}

/* --- Hard reset for table rendering --- */
table, thead, tbody, tfoot, tr, th, td {
  all: revert;
}
table.table { width: 100%; border-collapse: collapse; }
table.table thead { display: table-header-group !important; }
table.table tbody { display: table-row-group !important; }
table.table tr    { display: table-row !important; }
table.table th,
table.table td    { display: table-cell !important; padding: 12px; }
table.table tr.grid,
table.table tr.flex,
table.table tr[class*="grid"],
table.table tr[class*="flex"] { display: table-row !important; }
.card .card-b { overflow: visible; }
</style>
</head>
<body class="<?= $auth_page ? 'auth-page' : '' ?>">
<div class="wrap">
  <?php if(is_logged_in()): ?>
  <aside class="sidebar">
    <div class="brand">
      <h1>Workshop17</h1>
      <p><?= e(($me['first_name'] ?? '').' '.($me['last_name'] ?? '')) ?> (<?= e($me['role'] ?? '') ?>)</p>
    </div>
    <nav class="nav">
      <a href="<?= BASE_URL ?>/dashboard.php" class="<?= basename($_SERVER['PHP_SELF'])==='dashboard.php'?'active':'' ?>">üìä Dashboard</a>
      <a href="<?= BASE_URL ?>/tickets.php" class="<?= basename($_SERVER['PHP_SELF'])==='tickets.php'?'active':'' ?>">üé´ Tickets</a>
      <a href="<?= BASE_URL ?>/tasks.php" class="<?= basename($_SERVER['PHP_SELF'])==='tasks.php'?'active':'' ?>">üìã Tasks</a>
      <a href="<?= BASE_URL ?>/locations.php" class="<?= basename($_SERVER['PHP_SELF'])==='locations.php'?'active':'' ?>">üìç Locations</a>
      <a href="<?= BASE_URL ?>/orgchart.php" class="<?= basename($_SERVER['PHP_SELF'])==='locations.php'?'active':'' ?>">üó£Ô∏è Organogram</a>
      <?php if(($me['role']??'')==='admin'): ?>
        <a href="<?= BASE_URL ?>/users.php" class="<?= basename($_SERVER['PHP_SELF'])==='users.php'?'active':'' ?>">üë• Users</a>
      <?php endif; ?>
      <a href="<?= BASE_URL ?>/logout.php">üö™ Logout</a>
    </nav>
  </aside>
  <?php endif; ?>
  <main class="main">
